import { initializeApp, getApps, cert, App } from 'firebase-admin/app'
import { getFirestore, Firestore } from 'firebase-admin/firestore'

// Firebase Admin SDK for server-side operations
// This bypasses Firestore security rules and should only be used in server-side code

let adminApp: App | undefined
let adminDb: Firestore | undefined

function getAdminApp(): App {
    if (adminApp) return adminApp

    const existingApps = getApps()
    if (existingApps.length > 0) {
        adminApp = existingApps[0]
        return adminApp
    }

    // Use service account credentials from environment variables
    const clientEmail = process.env.FIREBASE_CLIENT_EMAIL
    const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n')
    const projectId = process.env.FIREBASE_PROJECT_ID || process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID

    if (!clientEmail || !privateKey || !projectId) {
        throw new Error(
            'Missing Firebase Admin credentials. Please set FIREBASE_CLIENT_EMAIL, FIREBASE_PRIVATE_KEY, and FIREBASE_PROJECT_ID environment variables.'
        )
    }

    adminApp = initializeApp({
        credential: cert({
            projectId,
            clientEmail,
            privateKey,
        }),
        projectId,
    })

    return adminApp
}

export function getAdminDb(): Firestore {
    if (adminDb) return adminDb

    getAdminApp()
    adminDb = getFirestore()
    return adminDb
}

export { getAdminApp }
